<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web AR çµ‚æ¥µç‰ˆ (å¤šäºº+æ‹ç…§ä¿®æ­£)</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: #1a1a1a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-y: auto;
        }

        /* å½±ç‰‡é¡¯ç¤ºå€ */
        .viewport {
            position: relative;
            width: 100%;
            max-width: 640px;
            aspect-ratio: 4/3;
            background: #000;
            margin-top: 10px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            flex-shrink: 0;
        }

        #webcam { display: none; }
        #output_canvas { width: 100%; height: 100%; object-fit: cover; }

        /* æ§åˆ¶é¢æ¿å€ */
        .controls {
            width: 100%;
            max-width: 640px;
            padding: 20px 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* èª¿æ•´æ»‘æ¡¿é¢æ¿ */
        .adjust-panel {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .slider-row {
            display: flex;
            align-items: center;
            font-size: 14px;
            gap: 10px;
        }
        .slider-row label { width: 40px; text-align: right; font-weight: bold; }
        .slider-row input { flex-grow: 1; cursor: pointer; height: 6px; }
        .slider-row span { width: 40px; text-align: left; opacity: 0.8; font-family: monospace; padding-left: 5px;}

        /* æŒ‰éˆ•èˆ‡æ’ç‰ˆ */
        .row { display: flex; gap: 10px; justify-content: space-between; }
        
        button, select, label.btn {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #333;
            color: white;
            cursor: pointer;
            font-size: 14px;
            text-align: center;
        }
        
        button.primary, label.primary { background-color: #007bff; border: none; }
        button.snap { background-color: #ff9800; border: none; flex-grow: 1; font-weight: bold;}
        button:hover, label.btn:hover { filter: brightness(1.1); }
        button:active { transform: translateY(1px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* åœ–ç‰‡ç¸®åœ–åˆ— */
        .asset-bar {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px;
            background: #222;
            border-radius: 8px;
            scrollbar-width: none; /* Firefox */
        }
        .asset-bar::-webkit-scrollbar { display: none; /* Chrome/Safari */ }

        .asset-item {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            border: 2px solid #444;
            background: #fff;
            object-fit: contain;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .asset-item:hover { transform: scale(1.05); }
        .asset-item.active { border-color: #007bff; transform: scale(1.1); box-shadow: 0 0 10px rgba(0,123,255,0.3); }

        #fileInput { display: none; }
        #status { font-size: 12px; color: #aaa; text-align: center; }
    </style>
</head>
<body>

    <div class="viewport">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="output_canvas"></canvas>
    </div>

    <div class="controls">
        
        <div class="adjust-panel">
            <div style="font-size:12px; color:#aaa; display:flex; justify-content:space-between;">
                <span>ğŸ› ï¸ ä½ç½®èˆ‡å¤§å° (åŒæ­¥æ‰€æœ‰è‡‰éƒ¨)</span>
                <button id="resetBtn" style="padding: 2px 8px; font-size: 11px; height:auto;">é‡ç½®</button>
            </div>
            <div class="slider-row">
                <label>â†•ï¸</label>
                <input type="range" id="offsetY" min="-200" max="100" value="-80">
                <span id="valY">-80</span>
            </div>
            <div class="slider-row">
                <label>â†”ï¸</label>
                <input type="range" id="offsetX" min="-100" max="100" value="0">
                <span id="valX">0</span>
            </div>
            <div class="slider-row">
                <label>ğŸ”</label>
                <input type="range" id="scale" min="10" max="500" value="250">
                <span id="valScale">2.5</span>
            </div>
        </div>

        <div id="status">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
        
        <div class="row">
            <select id="cameraSelect"><option>æœå°‹ç›¸æ©Ÿ...</option></select>
            <button id="snapButton" class="snap" disabled>ğŸ“¸ æ‹ç…§å­˜æª”</button>
        </div>

        <div class="row">
            <label for="fileInput" class="btn primary" style="width:100%">ğŸ“‚ åŒ¯å…¥åœ–ç‰‡ (æ”¯æ´å¤šé¸)</label>
            <input type="file" id="fileInput" multiple accept="image/*">
        </div>

        <div class="asset-bar" id="assetBar">
            <img src="https://cdn-icons-png.flaticon.com/512/1864/1864514.png" class="asset-item active" crossorigin="anonymous" title="è²“">
        </div>
    </div>

    <script type="module">
        import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

        // DOM å…ƒç´ é¸å–
        const video = document.getElementById("webcam");
        const canvas = document.getElementById("output_canvas");
        const ctx = canvas.getContext("2d");
        const statusText = document.getElementById("status");
        const assetBar = document.getElementById("assetBar");
        
        const sliderY = document.getElementById("offsetY");
        const sliderX = document.getElementById("offsetX");
        const sliderScale = document.getElementById("scale");
        const valY = document.getElementById("valY");
        const valX = document.getElementById("valX");
        const valScale = document.getElementById("valScale");
        const resetBtn = document.getElementById("resetBtn");
        const snapButton = document.getElementById("snapButton");

        // å…¨åŸŸè®Šæ•¸
        let faceLandmarker;
        let lastVideoTime = -1;
        let activeImage = assetBar.children[0];
        let imageSettingsMap = new Map(); // è¨˜æ†¶æ¯å¼µåœ–çš„è¨­å®š

        // --- 1. è¨­å®šå€¼ç®¡ç†é‚è¼¯ ---
        function updateSettingsDisplay() {
            valY.innerText = sliderY.value;
            valX.innerText = sliderX.value;
            valScale.innerText = (sliderScale.value / 100).toFixed(1);
        }

        function saveCurrentSettings() {
            if(!activeImage) return;
            imageSettingsMap.set(activeImage.src, {
                y: parseInt(sliderY.value),
                x: parseInt(sliderX.value),
                s: parseInt(sliderScale.value)
            });
        }

        function loadSettingsForImage(img) {
            const saved = imageSettingsMap.get(img.src);
            if (saved) {
                sliderY.value = saved.y;
                sliderX.value = saved.x;
                sliderScale.value = saved.s;
            } else {
                // é è¨­å€¼
                sliderY.value = -80;
                sliderX.value = 0;
                sliderScale.value = 250;
            }
            updateSettingsDisplay();
        }

        // ç›£è½æ»‘æ¡¿
        [sliderY, sliderX, sliderScale].forEach(el => {
            el.addEventListener("input", () => {
                updateSettingsDisplay();
                saveCurrentSettings();
            });
        });

        // é‡ç½®æŒ‰éˆ•
        resetBtn.addEventListener("click", () => {
            sliderY.value = -80;
            sliderX.value = 0;
            sliderScale.value = 250;
            updateSettingsDisplay();
            saveCurrentSettings();
        });

        // --- 2. åˆå§‹åŒ– AI æ¨¡å‹ ---
        async function init() {
            try {
                const filesetResolver = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
                );
                faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
                    baseOptions: {
                        modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                        delegate: "GPU"
                    },
                    runningMode: "VIDEO",
                    numFaces: 5 // è¨­å®šæœ€å¤šåµæ¸¬ 5 å¼µè‡‰
                });
                statusText.innerText = "æ¨¡å‹å°±ç·’ï¼Œè«‹é–‹å•Ÿç›¸æ©Ÿ";
                setupCamera();
            } catch (e) {
                statusText.innerText = "æ¨¡å‹è¼‰å…¥å¤±æ•—: " + e;
            }
        }
        init();

        // --- 3. ç›¸æ©Ÿè¨­å®š ---
        async function setupCamera() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(d => d.kind === 'videoinput');
            const select = document.getElementById("cameraSelect");
            select.innerHTML = "";
            
            videoDevices.forEach(device => {
                const opt = document.createElement("option");
                opt.value = device.deviceId;
                opt.text = device.label || "ç›¸æ©Ÿ " + (select.length + 1);
                select.appendChild(opt);
            });

            // å•Ÿå‹•ç¬¬ä¸€å€‹ç›¸æ©Ÿ
            startCamera(videoDevices[0]?.deviceId);
            
            // ç›£è½åˆ‡æ›
            select.addEventListener("change", (e) => startCamera(e.target.value));
        }

        async function startCamera(deviceId) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        deviceId: deviceId ? { exact: deviceId } : undefined, 
                        width: { ideal: 1280 }, 
                        height: { ideal: 720 } 
                    }
                });
                video.srcObject = stream;
                video.addEventListener("loadeddata", predictWebcam);
                snapButton.disabled = false;
                statusText.innerText = "é‹ä½œä¸­ - æ”¯æ´å¤šäººè‡‰éƒ¨åµæ¸¬";
            } catch(e) {
                statusText.innerText = "ç›¸æ©ŸéŒ¯èª¤: " + e.message;
            }
        }

        // --- 4. æ ¸å¿ƒåµæ¸¬è¿´åœˆ ---
        async function predictWebcam() {
            // ç¢ºä¿ Canvas å°ºå¯¸æ­£ç¢º
            if(canvas.width !== video.videoWidth || canvas.height !== video.videoHeight){
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }

            if (lastVideoTime !== video.currentTime) {
                lastVideoTime = video.currentTime;
                const results = faceLandmarker.detectForVideo(video, performance.now());

                // æ¸…é™¤ç•«é¢
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // é¡åƒç¿»è½‰èˆ‡ç¹ªè£½åŸå§‹å½±ç‰‡
                ctx.save();
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // éæ­·æ‰€æœ‰åµæ¸¬åˆ°çš„è‡‰
                if (results.faceLandmarks && results.faceLandmarks.length > 0 && activeImage) {
                    for (const landmarks of results.faceLandmarks) {
                        drawOverlay(landmarks);
                    }
                }
                ctx.restore();
            }
            window.requestAnimationFrame(predictWebcam);
        }

        // --- 5. ç¹ªåœ–é‚è¼¯ ---
        function drawOverlay(landmarks) {
            const w = canvas.width;
            const h = canvas.height;
            
            // é—œéµé»
            const top = landmarks[10]; 
            const left = landmarks[234];
            const right = landmarks[454];

            // è¨ˆç®—å¹¾ä½•
            const faceW = Math.hypot((right.x - left.x) * w, (right.y - left.y) * h);
            const angle = Math.atan2((right.y - left.y) * h, (right.x - left.x) * w);

            // è®€å–æ»‘æ¡¿æ•¸å€¼
            const scaleVal = sliderScale.value / 100;
            const offYVal = sliderY.value / 100;
            const offXVal = sliderX.value / 100;

            const imgAspect = activeImage.naturalWidth / activeImage.naturalHeight;
            const drawWidth = faceW * scaleVal;
            const drawHeight = drawWidth / imgAspect;

            ctx.save();
            ctx.translate(top.x * w, top.y * h);
            ctx.rotate(angle);
            
            // è¨ˆç®—åç§»
            const moveX = faceW * offXVal;
            const moveY = faceW * offYVal;

            ctx.drawImage(
                activeImage, 
                (-drawWidth / 2) + moveX, 
                moveY, 
                drawWidth, 
                drawHeight
            );
            
            ctx.restore();
        }

        // --- 6. åœ–ç‰‡èˆ‡åˆ—è¡¨é‚è¼¯ ---
        function setActive(img) {
            document.querySelectorAll('.asset-item').forEach(e => e.classList.remove('active'));
            img.classList.add('active');
            activeImage = img;
            loadSettingsForImage(img);
        }
        
        // ç¶å®šé è¨­åœ–ç‰‡
        activeImage.onclick = () => setActive(activeImage);

        // ç¶å®šä¸Šå‚³
        document.getElementById("fileInput").addEventListener("change", (e) => {
            for (let file of e.target.files) {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.className = "asset-item";
                img.onload = () => { img.onclick = () => setActive(img); };
                assetBar.appendChild(img);
                // å¦‚æœæ˜¯ç¬¬äºŒå¼µ(ç¬¬ä¸€å¼µä¸Šå‚³çš„)ï¼Œè‡ªå‹•é¸ä¸­
                if(assetBar.children.length === 2) setActive(img);
            }
        });

        // --- 7. æ‹ç…§å­˜æª” (å¢å¼·ç‰ˆ) ---
        snapButton.addEventListener("click", () => {
            // è¦–è¦ºå›é¥‹ï¼šé–ƒå…‰ç‡ˆ
            ctx.save();
            ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.restore();

            setTimeout(() => {
                try {
                    const dataURL = canvas.toDataURL("image/png");
                    const link = document.createElement('a');
                    const time = new Date().toISOString().replace(/[:.]/g, "-");
                    link.download = `AR-Photo-${time}.png`;
                    link.href = dataURL;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (e) {
                    console.error(e);
                    alert("âš ï¸ å­˜æª”å¤±æ•—ï¼\n\nåŸå› ï¼šç€è¦½å™¨å®‰å…¨æ€§é™åˆ¶ (CORS)ã€‚\nè«‹æ”¹ç”¨ 'Live Server' é–‹å•Ÿæ­¤ç¶²é ï¼Œä¸è¦ç›´æ¥é»æ“Š index.html é–‹å•Ÿã€‚");
                }
            }, 100);
        });

    </script>
</body>
</html>