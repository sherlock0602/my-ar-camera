<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Web AR é˜²å‡çµä¿®å¾©ç‰ˆ</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: #000;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        .viewport {
            position: relative;
            width: 100%;
            max-width: 100%;
            flex-grow: 1;
            background: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* é—œéµä¿®æ­£ï¼šåŠ å…¥ muted å±¬æ€§ */
        #webcam { display: none; }
        
        #output_canvas { 
            max-width: 100%; 
            max-height: 100%;
            object-fit: contain;
        }

        .adjust-panel {
            position: absolute;
            top: 10px; left: 10px; right: 10px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 12px;
            z-index: 100;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .slider-row {
            display: flex; align-items: center;
            font-size: 14px; gap: 10px; margin-bottom: 5px;
        }
        .slider-row label { min-width: 25px; text-align: center; }
        .slider-row input { flex-grow: 1; height: 20px; }
        .slider-row span { min-width: 30px; font-size: 12px; text-align: right; }

        .controls {
            width: 100%;
            background: #111;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 101;
            padding-bottom: 20px;
        }

        .btn-group { display: flex; gap: 8px; }
        
        button, label.btn {
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: #333;
            color: white;
            font-size: 14px;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        
        button.primary, label.primary { background-color: #007bff; }
        button.snap { background-color: #ff9800; font-weight: bold; flex: 2;}
        button:active { transform: scale(0.95); }

        .asset-bar {
            display: flex; gap: 10px; overflow-x: auto;
            padding: 5px 0; background: #111;
        }
        .asset-item {
            width: 50px; height: 50px;
            border-radius: 8px; border: 2px solid #444;
            background: #fff; object-fit: contain; flex-shrink: 0;
        }
        .asset-item.active { border-color: #007bff; transform: scale(1.1); }

        #fileInput { display: none; }
        
        /* æ–°å¢ï¼šé»æ“Šå–šé†’æç¤º */
        #status { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 20px; border-radius: 10px;
            text-align: center; z-index: 200;
            pointer-events: none; /* è®“é»æ“Šå¯ä»¥ç©¿é€ */
        }
        
        /* é™¤éŒ¯è³‡è¨Š (å¯é¸) */
        #debug {
            position: absolute; bottom: 10px; right: 10px;
            font-size: 10px; color: yellow; z-index: 500;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="status">ç³»çµ±å•Ÿå‹•ä¸­...</div>
    <div id="debug">FPS: 0</div>

    <div class="viewport" id="viewportArea">
        <div class="adjust-panel">
            <div class="slider-row">
                <label>â†•ï¸</label><input type="range" id="offsetY" min="-200" max="100" value="-80"><span id="valY">-80</span>
            </div>
            <div class="slider-row">
                <label>â†”ï¸</label><input type="range" id="offsetX" min="-100" max="100" value="0"><span id="valX">0</span>
            </div>
            <div class="slider-row">
                <label>ğŸ”</label><input type="range" id="scale" min="10" max="500" value="250"><span id="valScale">2.5</span>
            </div>
        </div>

        <video id="webcam" autoplay muted playsinline webkit-playsinline></video>
        <canvas id="output_canvas"></canvas>
    </div>

    <div class="controls">
        <div class="btn-group">
            <button id="switchCamBtn">ğŸ”„ åˆ‡æ›é¡é ­</button>
            <button id="snapButton" class="snap" disabled>ğŸ“¸ æ‹ç…§</button>
        </div>

        <div class="btn-group">
            <label for="fileInput" class="btn primary">ğŸ“‚ åŒ¯å…¥åœ–ç‰‡</label>
            <input type="file" id="fileInput" multiple accept="image/*">
        </div>

        <div class="asset-bar" id="assetBar">
            <img src="https://cdn-icons-png.flaticon.com/512/1864/1864514.png" class="asset-item active" crossorigin="anonymous">
            <img src="https://cdn-icons-png.flaticon.com/512/616/616430.png" class="asset-item" crossorigin="anonymous">
        </div>
    </div>

    <script type="module">
        import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

        const video = document.getElementById("webcam");
        const canvas = document.getElementById("output_canvas");
        const ctx = canvas.getContext("2d");
        const statusText = document.getElementById("status");
        const switchCamBtn = document.getElementById("switchCamBtn");
        const snapButton = document.getElementById("snapButton");
        const assetBar = document.getElementById("assetBar");
        const debugText = document.getElementById("debug");

        const sliderY = document.getElementById("offsetY");
        const sliderX = document.getElementById("offsetX");
        const sliderScale = document.getElementById("scale");
        const valY = document.getElementById("valY");
        const valX = document.getElementById("valX");
        const valScale = document.getElementById("valScale");

        let faceLandmarker;
        let lastVideoTime = -1;
        let activeImage = assetBar.children[0];
        let imageSettingsMap = new Map();
        
        let useFrontCamera = true; 
        let currentStream = null;
        let isPredicting = false;
        let frameCount = 0; // ç”¨æ–¼é™¤éŒ¯

        // 1. UI èˆ‡è¨­å®š
        function updateDisplay() {
            valY.innerText = sliderY.value;
            valX.innerText = sliderX.value;
            valScale.innerText = (sliderScale.value / 100).toFixed(1);
            if(activeImage) {
                imageSettingsMap.set(activeImage.src, {
                    y: parseInt(sliderY.value), x: parseInt(sliderX.value), s: parseInt(sliderScale.value)
                });
            }
        }
        [sliderY, sliderX, sliderScale].forEach(el => el.addEventListener("input", updateDisplay));

        function setActive(img) {
            document.querySelectorAll('.asset-item').forEach(e => e.classList.remove('active'));
            img.classList.add('active');
            activeImage = img;
            const saved = imageSettingsMap.get(img.src);
            if (saved) {
                sliderY.value = saved.y; sliderX.value = saved.x; sliderScale.value = saved.s;
            } else {
                sliderY.value = -80; sliderX.value = 0; sliderScale.value = 250;
            }
            updateDisplay();
        }
        activeImage.onclick = () => setActive(activeImage);

        // 2. åˆå§‹åŒ– AI
        async function init() {
            try {
                const filesetResolver = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
                );
                faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
                    baseOptions: {
                        modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                        delegate: "GPU"
                    },
                    runningMode: "VIDEO",
                    numFaces: 3 // é™ç‚º 3 äººï¼Œæ¸›è¼•å¹³æ¿è² æ“”
                });
                startCamera();
            } catch (e) {
                statusText.innerHTML = "ç³»çµ±éŒ¯èª¤: " + e;
            }
        }

        // 3. å•Ÿå‹•ç›¸æ©Ÿ (åŠ å…¥å¼·åˆ¶æ’­æ”¾æ©Ÿåˆ¶)
        async function startCamera() {
            statusText.style.display = "block";
            statusText.innerText = "å•Ÿå‹•ç›¸æ©Ÿ...";
            
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    facingMode: useFrontCamera ? "user" : "environment",
                    width: { ideal: 640 }, // ç¶­æŒä½è§£æåº¦
                    height: { ideal: 480 }
                }
            };

            try {
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                // é—œéµä¿®æ­£ï¼šç¢ºä¿å½±ç‰‡çœŸçš„é–‹å§‹æ’­æ”¾
                video.onloadedmetadata = () => {
                    video.play(); // å¼·åˆ¶æ’­æ”¾
                };

                video.onloadeddata = () => {
                    statusText.style.display = "none";
                    snapButton.disabled = false;
                    if(!isPredicting) {
                        isPredicting = true;
                        predictWebcam();
                    }
                };
            } catch (err) {
                statusText.innerHTML = "ç›¸æ©Ÿå¤±æ•—<br>" + err.name;
            }
        }

        // 4. é æ¸¬è¿´åœˆ (åŠ å…¥é˜²å¡æ­»æ©Ÿåˆ¶)
        async function predictWebcam() {
            // å¦‚æœå½±ç‰‡çªç„¶æš«åœäº†ï¼Œå˜—è©¦å†æ¬¡æ’­æ”¾
            if (video.paused) {
                try { await video.play(); } catch(e) {}
            }

            if (video.videoWidth > 0 && video.videoHeight > 0) {
                if(canvas.width !== video.videoWidth || canvas.height !== video.videoHeight){
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                }

                let startTimeMs = performance.now();
                if (lastVideoTime !== video.currentTime) {
                    lastVideoTime = video.currentTime;
                    
                    // åŸ·è¡Œåµæ¸¬
                    const results = faceLandmarker.detectForVideo(video, startTimeMs);

                    // æ¸…é™¤ç•«é¢
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // ç¹ªè£½
                    ctx.save();
                    if(useFrontCamera) {
                        ctx.translate(canvas.width, 0);
                        ctx.scale(-1, 1);
                    }
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                    if (results.faceLandmarks && activeImage) {
                        for (const landmarks of results.faceLandmarks) {
                            drawOverlay(landmarks);
                        }
                    }
                    ctx.restore();
                    
                    // æ›´æ–° FPS é¡¯ç¤ºï¼Œè­‰æ˜ç•«é¢æœ‰åœ¨å‹•
                    frameCount++;
                    if(frameCount % 30 === 0) debugText.innerText = "Run: " + Math.round(startTimeMs/1000) + "s";
                }
            }
            
            // æŒçºŒå‘¼å«ä¸‹ä¸€å¹€
            window.requestAnimationFrame(predictWebcam);
        }

        function drawOverlay(landmarks) {
            const w = canvas.width;
            const h = canvas.height;
            const top = landmarks[10]; 
            const left = landmarks[234];
            const right = landmarks[454];

            const faceW = Math.hypot((right.x - left.x) * w, (right.y - left.y) * h);
            const angle = Math.atan2((right.y - left.y) * h, (right.x - left.x) * w);

            const scaleVal = sliderScale.value / 100;
            const offYVal = sliderY.value / 100;
            const offXVal = sliderX.value / 100;
            const imgAspect = activeImage.naturalWidth / activeImage.naturalHeight;
            const drawWidth = faceW * scaleVal;
            const drawHeight = drawWidth / imgAspect;

            ctx.save();
            ctx.translate(top.x * w, top.y * h);
            ctx.rotate(angle);
            ctx.drawImage(activeImage, (-drawWidth/2) + faceW*offXVal, faceW*offYVal, drawWidth, drawHeight);
            ctx.restore();
        }

        // äº‹ä»¶ç¶å®š
        switchCamBtn.addEventListener("click", () => {
            useFrontCamera = !useFrontCamera;
            startCamera();
        });

        // æš´åŠ›å–šé†’ï¼šå¦‚æœç•«é¢å¡ä½ï¼Œé»æ“Šä»»ä½•åœ°æ–¹å¼·åˆ¶æ’­æ”¾
        document.body.addEventListener("click", () => {
            if(video.paused) video.play();
        });
        document.body.addEventListener("touchstart", () => {
            if(video.paused) video.play();
        });

        snapButton.addEventListener("click", () => {
            const flash = document.createElement("div");
            Object.assign(flash.style, {
                position: "fixed", top: 0, left: 0, width: "100%", height: "100%",
                background: "white", opacity: 0.8, zIndex: 999
            });
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 100);

            setTimeout(() => {
                const link = document.createElement('a');
                link.download = `AR-${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            }, 200);
        });

        document.getElementById("fileInput").addEventListener("change", (e) => {
            for (let file of e.target.files) {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.className = "asset-item";
                img.onload = () => { img.onclick = () => setActive(img); };
                assetBar.appendChild(img);
                if(assetBar.children.length === 2) setActive(img);
            }
        });

        init();
    </script>
</body>
</html>
